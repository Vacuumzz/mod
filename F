from telethon import events

from .. import loader, utils


class FinalistsMod(loader.Module):
    """–ú–æ–¥—É–ª—å –¥–ª—è —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —Ñ–∏–Ω–∞–ª–∏—Å—Ç–æ–≤ –≤ –∏–≥—Ä–µ "–ú–∞—Ñ–∏—è"."""

    def __init__(self):
        self.is_auto_enabled = False  # –§–ª–∞–≥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–ø–∏—Å–∫–∞ —Ñ–∏–Ω–∞–ª–∏—Å—Ç–æ–≤

    async def find_finalists(self, event):
        if 'üåô –ù–∞—Å—Ç—É–ø–∞–µ—Ç –Ω–æ—á—å ‚ùÑÔ∏è' in event.raw_text:
            async for message in event.client.iter_messages(event.input_chat, limit=2, reverse=True):
                if message.out:
                    continue
                if '–ñ–∏–≤—ã–µ –∏–≥—Ä–æ–∫–∏:' in message.raw_text:
                    players_list = message.raw_text.split('–ñ–∏–≤—ã–µ –∏–≥—Ä–æ–∫–∏:', 1)[1].strip()
                    if players_list.count('\n') >= 5:
                        return players_list
                    else:
                        prev_message = await event.client.get_messages(event.input_chat, ids=message.id - 1)
                        if prev_message and '–ñ–∏–≤—ã–µ –∏–≥—Ä–æ–∫–∏:' in prev_message.raw_text:
                            return prev_message.raw_text.split('–ñ–∏–≤—ã–µ –∏–≥—Ä–æ–∫–∏:', 1)[1].strip()
                    break
        return None

    @events.register(events.NewMessage)
    async def handle_message(self, event):
        if '–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!' in event.raw_text:
            finalists_list = await self.find_finalists(event)
            if finalists_list:
                await event.reply(f'–§–∏–Ω–∞–ª–∏—Å—Ç—ã:\n{finalists_list}')
            else:
                await event.reply('–§–∏–Ω–∞–ª–∏—Å—Ç–æ–≤ –Ω–µ—Ç')

        if self.is_auto_enabled and 'üåô –ù–∞—Å—Ç—É–ø–∞–µ—Ç –Ω–æ—á—å ‚ùÑÔ∏è' in event.raw_text:
            finalists_list = await self.find_finalists(event)
            if finalists_list:
                await event.reply(f'–§–∏–Ω–∞–ª–∏—Å—Ç—ã:\n{finalists_list}')
            else:
                await event.reply('–§–∏–Ω–∞–ª–∏—Å—Ç–æ–≤ –Ω–µ—Ç')

    @loader.unrestricted
    @loader.ratelimit
    async def finalistscmd(self, message):
        """
        –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è/–≤—ã–∫–ª—é—á–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–ø–∏—Å–∫–∞ —Ñ–∏–Ω–∞–ª–∏—Å—Ç–æ–≤.
        –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ ".finalists on" –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –∏ ".finalists off" –¥–ª—è –≤—ã–∫–ª—é—á–µ–Ω–∏—è.
        """
        args = utils.get_args(message)
        if args and args[0].lower() == 'on':
            self.is_auto_enabled = True
            await message.edit('–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–ø–∏—Å–∫–∞ —Ñ–∏–Ω–∞–ª–∏—Å—Ç–æ–≤ –≤–∫–ª—é—á–µ–Ω–∞.')
        elif args and args[0].lower() == 'off':
            self.is_auto_enabled = False
            await message.edit('–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–ø–∏—Å–∫–∞ —Ñ–∏–Ω–∞–ª–∏—Å—Ç–æ–≤ –≤—ã–∫–ª—é—á–µ–Ω–∞.')
        else:
            await message.edit('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∞—Ä–≥—É–º–µ–Ω—Ç. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ "on" –∏–ª–∏ "off".')
