from telethon import events

from .. import loader


class GameStatusModule(loader.Module):
    """Модуль для реагирования на статус игры"""

    def __init__(self):
        self.name = "Game Status Module"

    async def client_ready(self, client, db):
        self.db = db

    async def watcher(self, event):
        if isinstance(event, events.NewMessage) and "Игра окончена!" in event.raw_text:
            chat_id = event.chat_id
            messages = []
            async for message in event.client.iter_messages(chat_id, reverse=True):
                messages.append(message)
                if "Наступает ночь" in message.raw_text:
                    break
            messages.reverse()

            found_players_message = False
            players_message = ""
            for message in messages:
                if found_players_message:
                    players_message = message.raw_text
                    break
                elif "Живые игроки:" in message.raw_text:
                    found_players_message = True

            if players_message:
                response_message = f"Финалисты:\n{players_message}"
                await event.respond(response_message)

