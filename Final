from telethon import events
from telethon.tl.types import ChannelParticipantsAdmins

from .. import loader, utils


class FinalistsMod(loader.Module):
    """ĞœĞ¾Ğ´ÑƒĞ»ÑŒ Ğ´Ğ»Ñ ÑĞ¾ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ ÑĞ¿Ğ¸ÑĞºĞ° Ñ„Ğ¸Ğ½Ğ°Ğ»Ğ¸ÑÑ‚Ğ¾Ğ² Ğ² Ğ¸Ğ³Ñ€Ğµ "ĞœĞ°Ñ„Ğ¸Ñ"."""

    def __init__(self):
        self.is_auto_enabled = False  # Ğ¤Ğ»Ğ°Ğ³ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ¹ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ ÑĞ¿Ğ¸ÑĞºĞ° Ñ„Ğ¸Ğ½Ğ°Ğ»Ğ¸ÑÑ‚Ğ¾Ğ²
        self.finalists_list = None  # ĞŸĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ğ°Ñ Ğ´Ğ»Ñ Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ ÑĞ¿Ğ¸ÑĞºĞ° Ñ„Ğ¸Ğ½Ğ°Ğ»Ğ¸ÑÑ‚Ğ¾Ğ²

    async def find_finalists(self, event):
        if 'Ğ˜Ğ³Ñ€Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡ĞµĞ½Ğ°!' in event.raw_text:
            async for message in event.client.iter_messages(event.input_chat, limit=10, reverse=True):
                if message.out:
                    continue
                if 'ĞŸĞ¾Ğ±ĞµĞ´Ğ¸Ñ‚ĞµĞ»Ğ¸:' in message.raw_text:
                    return message.raw_text.strip()
        return None

    @loader.unrestricted
    @loader.ratelimit
    async def finalistscmd(self, message):
        """
        ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ´Ğ»Ñ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ/Ğ²Ñ‹ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ¹ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ ÑĞ¿Ğ¸ÑĞºĞ° Ñ„Ğ¸Ğ½Ğ°Ğ»Ğ¸ÑÑ‚Ğ¾Ğ².
        Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ ".finalists on" Ğ´Ğ»Ñ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ Ğ¸ ".finalists off" Ğ´Ğ»Ñ Ğ²Ñ‹ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ.
        """
        args = utils.get_args(message)
        if args and args[0].lower() == 'on':
            self.is_auto_enabled = True
            await message.edit('ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° ÑĞ¿Ğ¸ÑĞºĞ° Ñ„Ğ¸Ğ½Ğ°Ğ»Ğ¸ÑÑ‚Ğ¾Ğ² Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ°.')
        elif args and args[0].lower() == 'off':
            self.is_auto_enabled = False
            await message.edit('ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° ÑĞ¿Ğ¸ÑĞºĞ° Ñ„Ğ¸Ğ½Ğ°Ğ»Ğ¸ÑÑ‚Ğ¾Ğ² Ğ²Ñ‹ĞºĞ»ÑÑ‡ĞµĞ½Ğ°.')
        else:
            await message.edit('ĞĞµĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğ¹ Ğ°Ñ€Ğ³ÑƒĞ¼ĞµĞ½Ñ‚. Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ "on" Ğ¸Ğ»Ğ¸ "off".')

    @events.register(events.NewMessage)
    async def handle_message(self, event):
        if self.is_auto_enabled:
            if 'ğŸŒ Ğ£Ñ‚Ñ€Ğ¾:' in event.raw_text or 'ğŸŒ™ ĞĞ°ÑÑ‚ÑƒĞ¿Ğ°ĞµÑ‚ Ğ½Ğ¾Ñ‡ÑŒ â„ï¸' in event.raw_text:
                async for message in event.client.iter_messages(event.input_chat, limit=5, reverse=True):
                    if message.out:
                        continue
                    if 'Ğ–Ğ¸Ğ²Ñ‹Ğµ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¸:' in message.raw_text:
                        players_list = message.raw_text.split('Ğ–Ğ¸Ğ²Ñ‹Ğµ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¸:', 1)[1].strip()
                        if 'Ğ’ÑĞµĞ³Ğ¾:' in players_list:
                            if int(players_list.split('Ğ’ÑĞµĞ³Ğ¾:')[1].split('\n')[0].strip()) >= 5:
                                self.finalists_list = players_list
                                break

            elif 'Ğ˜Ğ³Ñ€Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡ĞµĞ½Ğ°!' in event.raw_text and self.finalists_list:
                winners_message = await self.find_finalists(event)
                if winners_message:
                    self.finalists_list += '\n\n' + winners_message
                    chat = await event.get_chat()
                    admins = await event.client.get_participants(chat, filter=ChannelParticipantsAdmins)
                    for admin in admins:
                        await event.client.send_message(admin, f'Ğ¤Ğ¸Ğ½Ğ°Ğ»Ğ¸ÑÑ‚Ñ‹:\n{self.finalists_list}')
